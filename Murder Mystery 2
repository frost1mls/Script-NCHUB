-- ========== CORREÇÕES E MELHORIAS 2026 ==========

-- Wallhack corrigido (salva/restaura transparência)
local originalTransparencies = {}  -- tabela global pra guardar valores

local function WallhackFunction()
    if functions.wallhack then
        for _, part in ipairs(workspace:GetDescendants()) do
            if part:IsA("BasePart") and part.Transparency < 0.6 and not part:IsDescendantOf(lp.Character) then
                if not originalTransparencies[part] then
                    originalTransparencies[part] = part.Transparency
                end
                part.Transparency = 0.75  -- valor bom pra ver através
            end
        end
    else
        for part, orig in pairs(originalTransparencies) do
            if part and part.Parent then
                part.Transparency = orig
            end
        end
        originalTransparencies = {}  -- limpa após restaurar
    end
end

-- ESP corrigido com Highlight + detecção melhor
local highlights = {}

local function UpdateESP()
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr == lp or not plr.Character then continue end
        
        local hasKnife = plr.Character:FindFirstChild("Knife") or plr.Backpack:FindFirstChild("Knife")
        local hasGun   = plr.Character:FindFirstChild("Gun")   or plr.Backpack:FindFirstChild("Gun")
        
        local role = "Innocent"
        if hasKnife then role = "Murderer" end
        if hasGun   then role = "Sheriff" end
        
        local shouldShow = (role == "Murderer" and functions.espMurder) or
                           (role == "Sheriff" and functions.espSheriff) or
                           (role == "Innocent" and functions.espInnocent)
        
        if shouldShow then
            if not highlights[plr] then
                local hl = Instance.new("Highlight")
                hl.Name = "NCHUB_ESP"
                hl.Adornee = plr.Character
                hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
                hl.FillTransparency = 0.45
                
                if role == "Murderer" then
                    hl.FillColor = Color3.fromRGB(255, 40, 40)
                    hl.OutlineColor = Color3.fromRGB(255, 200, 0)
                elseif role == "Sheriff" then
                    hl.FillColor = Color3.fromRGB(40, 120, 255)
                    hl.OutlineColor = Color3.fromRGB(220, 220, 255)
                else
                    hl.FillColor = Color3.fromRGB(40, 255, 100)
                    hl.OutlineColor = Color3.fromRGB(200, 255, 220)
                end
                
                hl.Parent = plr.Character
                highlights[plr] = hl
            end
        else
            if highlights[plr] then
                highlights[plr]:Destroy()
                highlights[plr] = nil
            end
        end
    end
end

-- Limpeza ao player sair
Players.PlayerRemoving:Connect(function(plr)
    if highlights[plr] then
        highlights[plr]:Destroy()
        highlights[plr] = nil
    end
end)

-- Auto Gun melhorado (sem tween excessivo, mais direto)
local function AutoGunFunction()
    if not functions.autoGun then return end
    local gun = FindGun()
    if gun and lp.Character and lp.Character:FindFirstChild("HumanoidRootPart") then
        local hrp = lp.Character.HumanoidRootPart
        local target = gun.Handle.Position + Vector3.new(0, 3, 0)
        local dist = (hrp.Position - target).Magnitude
        
        if dist < 12 then
            hrp.CFrame = CFrame.new(target)
            task.wait(0.08)
            firetouchinterest(hrp, gun.Handle, 0)
            task.wait(0.04)
            firetouchinterest(hrp, gun.Handle, 1)
        end
    end
end

-- Auto Collect corrigido (remove break, coleta todas)
local function AutoCollectFunction()
    if not functions.autoCollect then return end
    
    for _, obj in ipairs(workspace:GetDescendants()) do
        if obj:IsA("BasePart") and (obj.Name:lower():find("coin") or obj.Name:lower():find("candy") or obj.Name:lower():find("money")) then
            if lp.Character and lp.Character:FindFirstChild("HumanoidRootPart") then
                local hrp = lp.Character.HumanoidRootPart
                firetouchinterest(hrp, obj, 0)
                task.wait(0.015)
                firetouchinterest(hrp, obj, 1)
            end
        end
    end
end

-- ========== LOOP PRINCIPAL ATUALIZADO ==========
RunService.Heartbeat:Connect(function(delta)
    if functions.autoGun     then AutoGunFunction()     end
    if functions.autoCollect then AutoCollectFunction() end
    if functions.killAll     then KillAllFunction()     end
    if functions.espMurder or functions.espSheriff or functions.espInnocent then
        UpdateESP()
    end
    WallhackFunction()  -- roda sempre pra restaurar quando off
end)

-- Atualiza canvas uma última vez após tudo
task.wait(0.3)
UpdateCanvas()

print("NCHUB MM2 TININDO! Wallhack restaura, ESP Murder/Sheriff funciona, Auto farm real.")
